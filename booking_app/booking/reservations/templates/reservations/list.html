{% extends "base.html" %}

{% block content %}
<h2>Mis Reservas</h2>

{% if reservas %}
    <table>
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Hora</th>
                <th>Estado</th>
                <th>Acción</th>
            </tr>
        </thead>
        <tbody>
            {% for reserva in reservas %}
            <tr>
                <td>{{ reserva.date }}</td>
                <td>{{ reserva.time }}</td>
                <td>{% if reserva.is_confirmed %} Confirmado {% else %} Pendiente {% endif %}</td>
                <td>
                    {% if not reserva.is_confirmed %}
                        <form action="{% url 'confirm_reservation' reserva.id %}" method="POST">
                            {% csrf_token %}
                            <button type="submit">Confirmar</button>
                        </form>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% else %}
    <p>No tienes reservas aún.</p>
{% endif %}

<!-- Contenedor del calendario -->
<div id="calendar-container">
    <div id="calendar"></div>
</div>


{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function(){
        let calendarEl = document.getElementById("calendar");
    
        let calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: "dayGridMonth",
            selectable: true,
            locale: "es",
            events: "/reservas/eventos/",  // Carga los turnos ocupados desde Django
            dateClick: function(info) {  // Capturar selección de fecha
                if (confirm("¿Quieres reservar el día " + info.dateStr + "?")) {
                    fetch("/reservas/agregar/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": getCSRFToken()
                        },
                        body: JSON.stringify({ date: info.dateStr })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message) {
                            alert("Reserva creada con éxito.");
                            calendar.refetchEvents(); // Recargar eventos en el calendario
                        } else {
                            alert("Error: " + data.error);
                        }
                    })
                    .catch(error => console.error("Error:", error));
                }
            }
        });
    
        calendar.render();
    });
    
    // Función para obtener el token CSRF en Django
    function getCSRFToken() {
    const csrfInput = document.querySelector("[name=csrfmiddlewaretoken]");
    if (csrfInput) {
        return csrfInput.value; // Devuelve el valor si existe
    } else {
        console.error("CSRF token no encontrado en el DOM.");
        return null; // Evita que lance un error
    }
}

    </script>
    
{% endblock %}
{% block styles %}
<style>
    #calendar-container {
        max-width: 800px; /* Limita el ancho del calendario */
        margin: auto; /* Centrar el calendario */
        padding: 10px;
        border: 1px solid #ddd; /* Opcional: agregar un borde */
        background: #f8f9fa; /* Color de fondo suave */
    }
    #calendar {
        height: 450px; /* Ajusta la altura */
        max-width: 100%; /* Hace que se adapte al contenedor */
    }
</style>
{% endblock %}

